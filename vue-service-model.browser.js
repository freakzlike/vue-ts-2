var VueServiceModel=function(e,t,s,r){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;const n={isObject:(e,t=!1)=>!(!e||"object"!=typeof e)&&(!Array.isArray(e)||t),isNull:e=>null==e,clone(e){if(null===e||"object"!=typeof e)return e;const t=e.constructor();for(const s of Object.keys(e))t[s]=n.clone(e[s]);return t},mergeDeep(e,...t){if(!t.length)return e;const s=t.shift();if(s&&n.isObject(e)&&n.isObject(s))for(const t of Object.keys(s)){const r=s[t];n.isObject(r)?(e[t]||Object.assign(e,{[t]:{}}),n.mergeDeep(e[t],r)):Object.assign(e,{[t]:r})}return n.mergeDeep(e,...t)},deepCompare(e,t){if(e===t)return!0;if(n.isNull(e)||n.isNull(t))return!1;if(Array.isArray(e)!==Array.isArray(t))return!1;if(n.isObject(e,!0)!==n.isObject(t,!0))return!1;if(!n.isObject(e,!0))return e===t;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s of Object.keys(e)){if(!Object.prototype.hasOwnProperty.call(t,s))return!1;switch(typeof e[s]){case"object":if(!n.deepCompare(e[s],t[s]))return!1;break;case"function":if(void 0===t[s]||e[s].toString()!==t[s].toString())return!1;break;default:if(e[s]!==t[s])return!1}}return!0},eval:(e,t,...s)=>"function"==typeof e?e.call(t,...s):e,promiseEval:(e,t,...s)=>Promise.resolve(n.eval(e,t,...s)),format:(e,t)=>Object.keys(t).reduce((e,s)=>e.replace(new RegExp(`\\{${s}\\}`,"gi"),t[s]),e.toString()),NO_VALUE:{}};class i{get cls(){return this.constructor}static get cls(){return this}}class a extends Error{constructor(e,t){super('Field "'+t+'" not declared on Model "'+e.cls.name+'"'),this.constructor=a,this.__proto__=a.prototype}}class o extends Error{constructor(e){super('Missing url configuration in Model "'+e+'"'),this.constructor=o,this.__proto__=o.prototype}}class l extends i{constructor(e={}){super(),this._fields={},this._data=e,t.observable(this._data),this.cls.register(),this._bindFields()}static get _modelRegistered(){return!!Object.prototype.hasOwnProperty.call(this,"__modelRegistered")&&this.__modelRegistered}static set _modelRegistered(e){this.__modelRegistered=e}get data(){return this._data}set data(e){this._data=e}get fields(){return this._fields}get val(){return new Proxy(this,{get(e,t){const s=e.getField(t);return Promise.resolve(s.value)},set:(e,t,s)=>(e.getField(t).value=s,!0)})}get pk(){const e=this.getPrimaryKeyField();if(!e)return null;const t=e.valueGetter(this.data);return n.isNull(t)?null:t}getField(e){if(-1===Object.keys(this.fields).indexOf(e))throw new a(this,e);return this.fields[e]}getPrimaryKeyField(){const e=Object.values(this.fields).filter(e=>e.isPrimaryKey);return e.length>1&&console.warn("Multiple primary key fields found in model",this.constructor.name),e.length?e[0]:null}_bindFields(){this._fields={};const e=this.cls.fieldsDef;for(const t of Object.keys(e)){const s=e[t];this._fields[t]=s.bind({name:t,model:this})}}static register(){return!this._modelRegistered&&(this._modelRegistered=!0,!0)}}l.fieldsDef={},l.__modelRegistered=!1;class u extends Error{constructor(e,t="Unhandled APIException"){super(t),this.constructor=u,this.__proto__=u.prototype,this._response=e}get response(){return this._response}}class c extends u{constructor(e,t="Bad Request"){super(e,t),this.constructor=c,this.__proto__=c.prototype}}c.statusCode=400;class d extends u{constructor(e,t="Unauthorized"){super(e,t),this.constructor=d,this.__proto__=d.prototype}}d.statusCode=401;class h extends u{constructor(e,t="Forbidden"){super(e,t),this.constructor=h,this.__proto__=h.prototype}}h.statusCode=403;class p extends u{constructor(e,t="Not Found"){super(e,t),this.constructor=p,this.__proto__=p.prototype}}p.statusCode=404;class f extends u{constructor(e,t="Internal Server Error"){super(e,t),this.constructor=f,this.__proto__=f.prototype}}f.statusCode=500;class m{constructor(e){this.model=e}getServiceStoreOptions(e,t){return{noCache:Boolean(t&&t.noCache),noRequestAggregation:Boolean(t&&t.noRequestAggregation),refreshCache:Boolean(t&&t.refreshCache),...e}}async detail(e,t){const s=t&&t.parents;return new(0,this.model)(await this.retrieveDetailData(e,t),s)}async list(e){const t=e&&e.parents,s=e&&e.filter,r=this.model,n=await r.getListUrl(t),i=[n];s&&Object.keys(s).length>0&&i.push(JSON.stringify(s));const a=this.getServiceStoreOptions({key:i.join("?"),sendRequest:this.sendListRequest.bind(this),args:[n,e]},e);return(await r.store.getData(a)).map(e=>new r(e,t))}async create(e,t){const s=t&&t.parents,r=this.model,n=await r.getListUrl(s);return this.sendCreateRequest(n,e,t)}async update(e,t,s){const r=s&&s.parents,n=this.model,i=await n.getDetailUrl(e,r);return this.sendUpdateRequest(i,e,t,s)}async delete(e,t){const s=t&&t.parents,r=this.model,n=await r.getDetailUrl(e,s);return this.sendDeleteRequest(n,e,t)}async buildRetrieveRequestConfig(e){if(!e)return{};const t={};return e.filter&&Object.keys(e.filter).length&&(t.params=e.filter),t}async retrieveDetailData(e,t){const s=t&&t.parents,r=this.model,n=await r.getDetailUrl(e,s),i=this.getServiceStoreOptions({key:n,sendRequest:this.sendDetailRequest.bind(this),args:[n,e,t]},t);return r.store.getData(i)}async sendDetailRequest(e,t,r,n){const i=await this.buildRetrieveRequestConfig(n);let a;try{a=await s.get(t,i)}catch(e){throw await this.handleResponseError(e)}return this.mapDetailResponseBeforeCache(e,a.data,t,r,n)}async mapDetailResponseBeforeCache(e,t,s,r,n){return t}async sendListRequest(e,t,r){const n=await this.buildRetrieveRequestConfig(r);let i;try{i=await s.get(t,n)}catch(e){throw await this.handleResponseError(e)}return this.mapListResponseBeforeCache(e,i.data,t,r)}async mapListResponseBeforeCache(e,t,s,r){return t}async sendCreateRequest(e,t,r){let n;try{n=await s.post(e,t)}catch(e){throw await this.handleResponseError(e)}return n.data}async sendUpdateRequest(e,t,r,n){let i;try{i=await s.put(e,r)}catch(e){throw await this.handleResponseError(e)}return i.data}async sendDeleteRequest(e,t,r){try{await s.delete(e)}catch(e){throw await this.handleResponseError(e)}return null}async handleResponseError(e){if(!e.response)return e;switch(e.response.status){case c.statusCode:return new c(e.response);case d.statusCode:return new d(e.response);case h.statusCode:return new h(e.response);case p.statusCode:return new p(e.response);case f.statusCode:return new f(e.response);default:return new u(e.response)}}}class _{constructor(e){this.cacheDuration=e,this._data={},this._requests={}}async getData(e){const t=e.key;if(this.useCache(e)&&Object.prototype.hasOwnProperty.call(this._data,t)){const e=this._data[t];if(!e.expires||e.expires>Date.now())return e.data}return this.loadData(e)}async loadData(e){const t=e.key,s=this.getRequestAggregation(e);if(s)return s;const r=e.sendRequest(e,...e.args||[]).then(s=>(e.noCache||this._setData(t,s),this.removeRequest(t),s),e=>{throw this.removeRequest(t),e});return e.noRequestAggregation||this._setRequest(t,r),r}_setData(e,t){if(0!==this.cacheDuration){const s={data:t};null!==this.cacheDuration&&(s.expires=Date.now()+1e3*this.cacheDuration),this._data[e]=s}}_setRequest(e,t){this._requests[e]=t}useCache(e){return!e.noCache&&!e.refreshCache}getRequestAggregation(e){if(e.noRequestAggregation)return null;const t=e.key;return Object.prototype.hasOwnProperty.call(this._requests,t)?this._requests[t]:null}removeRequest(e){delete this._requests[e]}clean(){let e;const t=Date.now();for(e of Object.keys(this._data)){const s=this._data[e].expires;s&&s<t&&delete this._data[e]}}clear(){this._data={},this._requests={}}}class g extends l{constructor(e={},t={}){super(e),this._parents=n.clone(t)}static get store(){return Object.prototype.hasOwnProperty.call(this,"__store")||(this.__store=this.createStoreModule()),this.__store}static async getListUrl(e){this.checkServiceParents(e);const t=(()=>{if(this.urls.LIST)return this.urls.LIST;if(this.urls.BASE)return this.urls.BASE;throw new o(this.name)})();return e?n.format(t,e):t}static async getDetailUrl(e,t){this.checkServiceParents(t);const s=(()=>{if(this.urls.DETAIL)return this.urls.DETAIL;if(this.urls.BASE)return this.urls.BASE+"{pk}/";throw new o(this.name)})();return n.format(s,{pk:e,...t||{}})}static get objects(){if(!Object.prototype.hasOwnProperty.call(this,"__modelManager")){this.register();const e=this.ModelManager;this.__modelManager=new e(this)}return this.__modelManager}get parents(){return this._parents}set parents(e){this._parents=n.clone(e)}static checkServiceParents(e){const t=e||{};if(this.parentNames.length<Object.keys(t).length)return console.warn("Too much parents given",this.name,t),!1;if(this.parentNames.length>0){const e=this.parentNames.filter(e=>!t[e]);if(e.length)return console.warn("Missing parents",this.name,e),!1}return!0}async reload(){const e=this.pk;if(null===e)return!1;const t=this.constructor;return this.data=await t.objects.retrieveDetailData(e,{refreshCache:!0,parents:this.parents}),!0}static createStoreModule(){return new(0,this.storeClass)(this.cacheDuration)}}g.urls={},g.parentNames=[],g.cacheDuration=30,g.storeClass=_,g.ModelManager=m;class y extends Error{constructor(e){super('Field "'+e.cls.name+'" not bound or fieldName not set on new'),this.constructor=y,this.__proto__=y.prototype}}class w extends i{constructor(e={},t){super(),this._name=null,this._model=null,this._def=e,t&&(this._name=t.name,this._model=t.model||null)}clone(){const e=this.cls;if(this._name){const t={name:this._name};return this._model&&(t.model=this._model),new e(this._def,t)}return new e(this._def)}bind(e){return new(0,this.cls)(this._def,e)}get name(){if(null===this._name)throw new y(this);return this._name}get attributeName(){return this._def.attributeName||this.name}get definition(){return this._def}get model(){if(null===this._model)throw new y(this);return this._model}get value(){return Promise.resolve(this.valueGetter(this.model.data))}set value(e){this.valueSetter(e,this.model.data)}get label(){return n.promiseEval(this._def.label,this)}get hint(){return n.promiseEval(this._def.hint,this)}get isPrimaryKey(){return Boolean(this.definition.primaryKey)}valueGetter(e){if(!e||"object"!=typeof e)return null;if(!this.attributeName.includes(".")){const t=e[this.attributeName];return n.isNull(t)?null:t}const t=this.attributeName.split(".");let s,r=e;for(s of t)if(r=r[s],n.isNull(r))return null;return n.isNull(r)?null:r}valueSetter(e,s){if(this.attributeName.includes(".")){const r=this.attributeName.split(".");let i=0,a=r[i],o=s;for(;Object.prototype.hasOwnProperty.call(o,a)&&!n.isNull(o[a])&&(o=o[a],i++,a=r[i],i+1!==r.length););const l=r.splice(i+1).reduceRight((e,t)=>{const s={};return s[t]=e,s},e);t.set(o,a,l)}else t.set(s,this.attributeName,e)}get displayComponent(){return Promise.resolve().then((function(){return v}))}displayRender(e,t){return e("span",t)}get inputComponent(){return Promise.resolve().then((function(){return O}))}inputRender(e,t){return e("input",{attrs:{type:"text",value:t},on:{input:e=>{const t=e.target;this.value=t.value}}})}}t.use(r);var b=t.extend({name:"BaseDisplayFieldRender",inheritAttrs:!1,props:{field:{type:w,required:!0}},data:()=>({}),computed:{isValueLoaded(){return this.value!==n.NO_VALUE}},asyncComputed:{value:{default:n.NO_VALUE,get(){return this.field.value}}},methods:{renderField(e){return this.field.displayRender(e,this.value)}},render(e){return this.isValueLoaded?this.renderField(e):void 0}}),v=Object.freeze({__proto__:null,default:b}),R=b.extend({name:"BaseInputFieldRender",methods:{renderField(e){return this.field.inputRender(e,this.value)}}}),O=Object.freeze({__proto__:null,default:R});t.use(r);var C=t.extend({name:"DisplayField",inheritAttrs:!1,props:{model:{required:!0,validator:e=>e instanceof l||null===e},fieldName:{type:String,required:!0}},data:()=>({}),computed:{field(){if(this.model){return this.model.getField(this.fieldName)}return null}},asyncComputed:{async displayComponent(){if(this.field){const e=this.field;return(await e.displayComponent).default}return null}},render(e){return this.displayComponent&&this.field?e(this.displayComponent,{props:{field:this.field}}):void 0}});t.use(r);var D=t.extend({name:"InputField",inheritAttrs:!1,props:{model:{required:!0,validator:e=>e instanceof l||null===e},fieldName:{type:String,required:!0}},data:()=>({}),computed:{field(){if(this.model){return this.model.getField(this.fieldName)}return null}},asyncComputed:{async inputComponent(){if(this.field){const e=this.field;return(await e.inputComponent).default}return null}},render(e){return this.inputComponent&&this.field?e(this.inputComponent,{props:{field:this.field}}):void 0}});return e.APIException=u,e.BadRequestAPIException=c,e.BaseDisplayFieldRender=b,e.BaseInputFieldRender=R,e.BaseModel=l,e.DisplayField=C,e.Field=w,e.FieldNotBoundException=y,e.ForbiddenAPIException=h,e.InputField=D,e.InternalServerErrorAPIException=f,e.MissingUrlException=o,e.ModelManager=m,e.NotDeclaredFieldException=a,e.NotFoundAPIException=p,e.ServiceModel=g,e.ServiceStore=_,e.UnauthorizedAPIException=d,e}({},Vue,axios,AsyncComputed);
